import streamlit as st
import random
from fpdf import FPDF
import os

# 1. è¨­å®šé é¢é…ç½® (å¿…é ˆæ”¾åœ¨ç¬¬ä¸€è¡Œ)
st.set_page_config(page_title="æ•¸å­¸è‡ªå‹•å‡ºé¡Œç³»çµ±", layout="wide", page_icon="ğŸ“")

# ==========================================
# Part 1: é¡Œç›®ç”Ÿæˆæ ¸å¿ƒé‚è¼¯ (The Generator)
# ==========================================

def generate_algebra():
    """ç”Ÿæˆä»£æ•¸é‹ç®—é¡Œç›®: (ax + b)(cx + d) æˆ– (x+a)^2"""
    # éš¨æ©Ÿæ±ºå®šæ˜¯å¹³æ–¹å…¬å¼é‚„æ˜¯ä¹˜æ³•åˆ†é…å¾‹
    t_type = random.choice(['square', 'multiply'])
    
    if t_type == 'square':
        # (x + a)^2
        a = random.randint(-15, 15)
        if a == 0: a = 1
        sign = "+" if a > 0 else "-"
        # é¡Œç›®
        q_str = f"å±•é–‹ï¼š $(x {sign} {abs(a)})^2$"
        # ç­”æ¡ˆ: x^2 + 2ax + a^2
        ans_str = f"$x^2 {('+' if 2*a > 0 else '-')} {abs(2*a)}x + {a**2}$"
        
    else:
        # (x+a)(x+b)
        a = random.randint(-12, 12)
        b = random.randint(-12, 12)
        if a == 0: a = 1
        if b == 0: b = 1
        
        sign_a = "+" if a > 0 else "-"
        sign_b = "+" if b > 0 else "-"
        # é¡Œç›®
        q_str = f"å±•é–‹ï¼š $(x {sign_a} {abs(a)})(x {sign_b} {abs(b)})$"
        # ç­”æ¡ˆè¨ˆç®—
        mid = a + b
        const = a * b
        mid_sign = "+" if mid >= 0 else "-"
        const_sign = "+" if const >= 0 else "-"
        ans_str = f"$x^2 {mid_sign} {abs(mid)}x {const_sign} {abs(const)}$"

    return {
        "topic": "ä»£æ•¸é‹ç®—",
        "question": q_str,
        "answer": ans_str,
        "detail": "åˆ©ç”¨ä¹˜æ³•å…¬å¼æˆ–åˆ†é…å¾‹å±•é–‹æ•´ç†ã€‚"
    }

def generate_linear_eq():
    """ç”Ÿæˆä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼: ax + b = c"""
    # é€†å‘å·¥ç¨‹ï¼šå…ˆæ±ºå®šç­”æ¡ˆ xï¼Œå†ç®—å‡ºå¸¸æ•¸ cï¼Œç¢ºä¿ç­”æ¡ˆæ˜¯æ•´æ•¸
    x = random.randint(-20, 20)
    a = random.choice([k for k in range(-9, 10) if k != 0])
    b = random.randint(-50, 50)
    c = a * x + b
    
    b_sign = "+" if b >= 0 else "-"
    q_str = f"è§£æ–¹ç¨‹å¼ï¼š ${a}x {b_sign} {abs(b)} = {c}$"
    ans_str = f"$x = {x}$"
    
    return {
        "topic": "æ–¹ç¨‹å¼è§£é¡Œ",
        "question": q_str,
        "answer": ans_str,
        "detail": f"ç§»é …æ³•å‰‡ï¼šå…ˆå°‡å¸¸æ•¸é …ç§»è‡³å³é‚Šï¼Œå†é™¤ä»¥ x çš„ä¿‚æ•¸ã€‚\n{a}x = {c} - ({b})  =>  {a}x = {c-b}  =>  x = {x}"
    }

def generate_geometry():
    """ç”Ÿæˆå¹¾ä½•åœ–å½¢é¡Œç›®"""
    g_type = random.choice(['rect', 'tri'])
    
    if g_type == 'rect':
        w = random.randint(5, 30)
        h = random.randint(5, 30)
        q_str = f"é•·æ–¹å½¢é•·ç‚º {w} cmï¼Œå¯¬ç‚º {h} cmï¼Œæ±‚é¢ç©ã€‚"
        ans_str = f"{w * h} $cm^2$"
        detail = "é•·æ–¹å½¢é¢ç© = é•· Ã— å¯¬"
    else:
        base = random.randint(6, 24)
        height = random.randrange(2, 20, 2) # ç¢ºä¿é«˜æ˜¯å¶æ•¸ï¼Œé¢ç©æ‰ä¸æœƒæœ‰å°æ•¸é»
        q_str = f"ä¸‰è§’å½¢åº•ç‚º {base}ï¼Œé«˜ç‚º {height}ï¼Œæ±‚é¢ç©ã€‚"
        ans_str = f"{int(base * height / 2)}"
        detail = "ä¸‰è§’å½¢é¢ç© = (åº• Ã— é«˜) / 2"
        
    return {
        "topic": "å¹¾ä½•åœ–å½¢",
        "question": q_str,
        "answer": ans_str,
        "detail": detail
    }

def generate_probability():
    """ç”Ÿæˆæ©Ÿç‡é¡Œç›®"""
    p_type = random.choice(['dice', 'balls'])
    
    if p_type == 'dice':
        target = random.randint(1, 6)
        q_str = f"æŠ•æ“²ä¸€é¡†å…¬æ­£éª°å­ï¼Œå‡ºç¾é»æ•¸å¤§æ–¼ {target} çš„æ©Ÿç‡ç‚ºä½•ï¼Ÿ"
        success = 6 - target
        if success == 0: ans_str = "0"
        elif success == 6: ans_str = "1"
        else: ans_str = f"$\\frac{{{success}}}{{6}}$"
        detail = f"éª°å­æœ‰ 6 é¢ã€‚å¤§æ–¼ {target} çš„é»æ•¸æœ‰ï¼š{list(range(target+1, 7)) if target<6 else 'ç„¡'}ï¼Œå…± {success} å€‹æƒ…å½¢ã€‚"
        
    else:
        red = random.randint(3, 8)
        blue = random.randint(3, 8)
        total = red + blue
        q_str = f"è¢‹ä¸­æœ‰ {red} é¡†ç´…çƒï¼Œ{blue} é¡†è—çƒï¼Œéš¨æ©Ÿå–å‡ºä¸€çƒç‚ºç´…çƒçš„æ©Ÿç‡ï¼Ÿ"
        ans_str = f"$\\frac{{{red}}}{{{total}}}$"
        detail = f"ç¸½çƒæ•¸ = {red} + {blue} = {total}ã€‚ç´…çƒæœ‰ {red} é¡†ï¼Œæ•…æ©Ÿç‡ç‚º {red}/{total}ã€‚"

    return {
        "topic": "æ©Ÿç‡èˆ‡çµ±è¨ˆ",
        "question": q_str,
        "answer": ans_str,
        "detail": detail
    }

# Dictionary ç­–ç•¥ï¼šå°‡å–®å…ƒåç¨±å°æ‡‰åˆ°å‡½æ•¸
TOPIC_MAPPING = {
    "ä»£æ•¸é‹ç®—": generate_algebra,
    "æ–¹ç¨‹å¼è§£é¡Œ": generate_linear_eq,
    "å¹¾ä½•åœ–å½¢": generate_geometry,
    "æ©Ÿç‡èˆ‡çµ±è¨ˆ": generate_probability
}

def generate_exam_data(selected_topics, num_questions):
    """æ ¹æ“šä½¿ç”¨è€…é¸é …ç”¢ç”Ÿé¡Œåº«"""
    if not selected_topics: return []
    exam_list = []
    for _ in range(num_questions):
        # 1. éš¨æ©Ÿé¸ä¸€å€‹å–®å…ƒ
        topic_name = random.choice(selected_topics)
        # 2. åŸ·è¡Œå°æ‡‰å‡½æ•¸
        generator_func = TOPIC_MAPPING[topic_name]
        exam_list.append(generator_func())
    return exam_list

# ==========================================
# Part 2: PDF åŒ¯å‡ºåŠŸèƒ½ (The Exporter)
# ==========================================

class PDFExport(FPDF):
    def footer(self):
        self.set_y(-15)
        # é å°¾å­—é«”è™•ç†
        try:
            self.set_font("TaipeiSans", '', 10)
        except:
            self.set_font("Arial", 'I', 8)
        self.cell(0, 10, f'Page {self.page_no()}', 0, 0, 'C')

def create_pdf(exam_data, custom_title, mode="student"):
    pdf = PDFExport()
    pdf.add_page()
    
    # --- é—œéµï¼šå­—å‹è¼‰å…¥ ---
    # é€™æ˜¯ç‚ºäº†è®“ PDF èƒ½é¡¯ç¤ºä¸­æ–‡ï¼Œå¿…é ˆè¦æœ‰ .ttf æª”æ¡ˆ
    font_path = 'TaipeiSansTCBeta-Regular.ttf'
    font_ready = False
    
    if os.path.exists(font_path):
        try:
            pdf.add_font('TaipeiSans', '', font_path, uni=True)
            pdf.set_font("TaipeiSans", '', 14)
            font_ready = True
        except Exception as e:
            print(f"å­—å‹è¼‰å…¥å¤±æ•—: {e}")
    
    # è‹¥ç„¡ä¸­æ–‡å­—å‹ï¼Œé¡¯ç¤ºè­¦å‘Š
    if not font_ready:
        pdf.set_font("Arial", '', 14)
        pdf.cell(0, 10, "Error: Chinese font not found (TaipeiSansTCBeta-Regular.ttf)", ln=True)
        pdf.ln(10)

    # æ¨™é¡Œ
    suffix = "(å­¸ç”Ÿå·)" if mode == "student" else "(è§£ç­”å·)"
    full_title = f"{custom_title} {suffix}"
    pdf.cell(0, 10, full_title, ln=True, align='C')
    pdf.ln(10)
    
    # è©¦é¡Œå…§å®¹
    for idx, item in enumerate(exam_data):
        # æ¸…é™¤ LaTeX ç¬¦è™Ÿä»¥ä¾¿ PDF é¡¯ç¤ºç´”æ–‡å­—
        clean_q = item['question'].replace('$', '').replace('\\frac', '').replace('{', '').replace('}', '/')
        clean_a = item['answer'].replace('$', '').replace('\\frac', '').replace('{', '').replace('}', '/')
        
        question_text = f"Q{idx+1}. [{item['topic']}] {clean_q}"
        pdf.multi_cell(0, 10, question_text)
        
        if mode == "student":
            # å­¸ç”Ÿç‰ˆï¼šç•™ç™½ 25mm ä¾›è¨ˆç®—
            pdf.ln(25) 
        else:
            # å®¶é•·ç‰ˆï¼šé¡¯ç¤ºç­”æ¡ˆèˆ‡è§£æ
            pdf.set_text_color(255, 0, 0) # ç´…è‰²
            pdf.multi_cell(0, 8, f"Ans: {clean_a}")
            
            pdf.set_font(size=10)
            pdf.set_text_color(100, 100, 100) # ç°è‰²
            pdf.multi_cell(0, 8, f"è§£æ: {item['detail']}")
            
            # æ¢å¾©è¨­å®š
            pdf.set_text_color(0, 0, 0)
            if font_ready: pdf.set_font("TaipeiSans", '', 14)
            else: pdf.set_font("Arial", '', 14)
            pdf.ln(5)

    return pdf.output(dest='S').encode('latin-1')

# ==========================================
# Part 3: Streamlit UI ä»‹é¢
# ==========================================

def main():
    st.title("ğŸ“ åœ‹ä¸­æ•¸å­¸å‡ºé¡Œç³»çµ± (é›²ç«¯ç‰ˆ)")
    st.markdown("æ­¡è¿ä½¿ç”¨ï¼é¸å¥½å–®å…ƒå¾Œï¼ŒæŒ‰ä¸‹æŒ‰éˆ•å³å¯ç”Ÿæˆ**ç„¡é™ç‰ˆæœ¬**çš„ç·´ç¿’å·ã€‚")
    st.markdown("---")

    # ----- å´é‚Šæ¬„è¨­å®š -----
    with st.sidebar:
        st.header("âš™ï¸ è©¦å·è¨­å®š")
        
        # 1. è‡ªè¨‚æ¨™é¡Œ (æ–¹ä¾¿å®¶é•·å€åˆ†ä¸åŒä½œæ¥­)
        custom_title = st.text_input("è©¦å·æ¨™é¡Œ", value="æ•¸å­¸è‡ªæˆ‘è©•é‡")
        
        # 2. é¸æ“‡å–®å…ƒ
        selected_topics = st.multiselect(
            "é¸æ“‡å–®å…ƒ (å¯è¤‡é¸)",
            options=list(TOPIC_MAPPING.keys()),
            default=["ä»£æ•¸é‹ç®—", "æ–¹ç¨‹å¼è§£é¡Œ"]
        )
        
        # 3. é¡Œç›®æ•¸é‡
        num_questions = st.slider("é¡Œç›®æ•¸é‡", 5, 50, 10)
        
        # 4. ç”ŸæˆæŒ‰éˆ•
        generate_btn = st.button("ğŸš€ å»ºç«‹æ–°è€ƒå·", type="primary")
        
        st.info("æç¤ºï¼šæ¯æ¬¡é»æ“ŠæŒ‰éˆ•ï¼Œé¡Œç›®æ•¸å€¼éƒ½æœƒéš¨æ©Ÿæ”¹è®Šï¼Œä¸æœƒé‡è¤‡ï¼")

    # ----- ä¸»æµç¨‹ -----
    
    # åˆå§‹åŒ– session state (å„²å­˜é¡Œç›®ç”¨)
    if "exam_data" not in st.session_state:
        st.session_state["exam_data"] = []
    
    # æŒ‰ä¸‹æŒ‰éˆ•å¾Œç”Ÿæˆ
    if generate_btn:
        if not selected_topics:
            st.error("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å–®å…ƒï¼")
        else:
            with st.spinner("é¡Œç›®é‹ç®—ä¸­..."):
                st.session_state["exam_data"] = generate_exam_data(selected_topics, num_questions)
            st.success(f"æˆåŠŸç”Ÿæˆ {len(st.session_state['exam_data'])} é¡Œï¼")

    # ----- é¡¯ç¤ºèˆ‡ä¸‹è¼‰ -----
    
    if st.session_state["exam_data"]:
        # é è¦½å€
        st.subheader(f"ğŸ‘€ {custom_title} - è©¦é¡Œé è¦½")
        
        # åªé¡¯ç¤ºå‰ 3 é¡Œ
        for i, q in enumerate(st.session_state["exam_data"][:3]):
            with st.expander(f"ç¬¬ {i+1} é¡Œ ({q['topic']})"):
                st.write(f"**é¡Œç›®**ï¼š {q['question']}")
                st.write(f"**ç­”æ¡ˆ**ï¼š {q['answer']}")
                st.caption(f"è§£æï¼š {q['detail']}")
        
        if len(st.session_state["exam_data"]) > 3:
            st.info(f"... é‚„æœ‰ {len(st.session_state['exam_data'])-3} é¡Œï¼Œè«‹ä¸‹è¼‰ PDF æŸ¥çœ‹å®Œæ•´ç‰ˆã€‚")

        st.divider()
        
        # ä¸‹è¼‰å€
        safe_title = custom_title.replace(" ", "_") # è™•ç†æª”åç©ºæ ¼
        
        col1, col2 = st.columns(2)
        
        with col1:
            # ç”¢ç”Ÿå­¸ç”Ÿç‰ˆ
            pdf_student = create_pdf(st.session_state["exam_data"], custom_title, mode="student")
            st.download_button(
                label="ğŸ“„ ä¸‹è¼‰å­¸ç”Ÿç‰ˆ (é¡Œç›®å·)",
                data=pdf_student,
                file_name=f"{safe_title}_å­¸ç”Ÿç‰ˆ.pdf",
                mime="application/pdf"
            )
            
        with col2:
            # ç”¢ç”Ÿå®¶é•·ç‰ˆ
            pdf_parent = create_pdf(st.session_state["exam_data"], custom_title, mode="parent")
            st.download_button(
                label="ğŸ‘¨â€ğŸ« ä¸‹è¼‰å®¶é•·ç‰ˆ (å«è§£æ)",
                data=pdf_parent,
                file_name=f"{safe_title}_è§£ç­”ç‰ˆ.pdf",
                mime="application/pdf"
            )

if __name__ == "__main__":
    main()